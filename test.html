<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>测试页面</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/echarts/dist/echarts.min.js"></script>
</head>
<body>
    <div id="app">
        <h1>测试饼图</h1>
        <div ref="chartDom" style="width: 600px; height: 400px; border: 1px solid #ccc;"></div>
        <button @click="updateData">更新数据</button>
        <p>Records: {{ records }}</p>
    </div>

    <script>
        const { createApp, ref, onMounted, nextTick } = Vue;

        const app = createApp({
            setup() {
                const chartDom = ref(null);
                const records = ref([
                    { name: 'NVDA', total: 1000 },
                    { name: 'TSLA', total: 500 },
                    { name: 'AAPL', total: 800 }
                ]);
                let myChart = null;

                function initChart() {
                    console.log('初始化图表');
                    console.log('chartDom.value:', chartDom.value);
                    if (!chartDom.value) {
                        console.error('chartDom 为空');
                        return;
                    }
                    myChart = echarts.init(chartDom.value);
                    console.log('myChart:', myChart);
                    updateChart();
                }

                function updateChart() {
                    console.log('更新图表');
                    if (!myChart) {
                        console.error('myChart 未初始化');
                        return;
                    }
                    if (!records || !records.value) {
                        console.error('records 为空');
                        return;
                    }

                    const agg = {};
                    records.value.forEach(item => {
                        agg[item.name] = (agg[item.name] || 0) + item.total;
                    });

                    const data = Object.keys(agg).map(k => ({
                        name: k,
                        value: agg[k]
                    }));

                    console.log('图表数据:', data);

                    const option = {
                        color: ['#10b981', '#3b82f6', '#f59e0b', '#8b5cf6', '#ec4899'],
                        tooltip: {
                            trigger: 'item',
                            formatter: (params) => {
                                return `${params.name}: $${params.value.toFixed(2)} (${params.percent}%)`;
                            }
                        },
                        legend: {
                            bottom: '0%',
                            left: 'center'
                        },
                        series: [{
                            type: 'pie',
                            radius: ['50%', '80%'],
                            center: ['50%', '45%'],
                            itemStyle: {
                                borderRadius: 8,
                                borderColor: '#fff',
                                borderWidth: 2
                            },
                            label: {
                                show: false
                            },
                            emphasis: {
                                label: {
                                    show: true,
                                    fontSize: 16,
                                    fontWeight: 'bold'
                                }
                            },
                            data: data.length > 0 ? data : [{ name: '暂无数据', value: 1 }]
                        }]
                    };

                    myChart.setOption(option, true);
                    console.log('图表更新完成');
                }

                function updateData() {
                    records.value.push({ name: 'GOOGL', total: 300 });
                    updateChart();
                }

                onMounted(() => {
                    console.log('组件已挂载');
                    nextTick(() => {
                        console.log('nextTick 执行');
                        initChart();
                    });
                });

                return {
                    chartDom,
                    records,
                    updateData
                };
            }
        });

        app.mount('#app');
    </script>
</body>
</html>
